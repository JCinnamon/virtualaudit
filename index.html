<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Audit Instrument</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: grid;
            grid-template-columns: 30% 70%;
            grid-template-rows: 60% 40%;
            height: 100vh;
        }
        #controlArea {
            grid-column: 1;
            grid-row: 1;
            padding: 20px;
            overflow-y: auto;
        }
        #map {
            grid-column: 1;
            grid-row: 2;
        }
        #pano {
            grid-column: 2;
            grid-row: 1 / span 2;
        }
        #form, #dateSelector, #buttons {
            margin-bottom: 20px;
        }
        #observationCount {
            margin-top: 10px;
            font-weight: bold;
        }
        h1 {
            margin-top: 0;
        }
        select, textarea {
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controlArea">
            <h1>Virtual Audit Instrument</h1>
            <div id="dateSelector">
                <label for="imageDate">Select Image Date:</label>
                <select id="imageDate"></select>
            </div>
            <form id="form">
                <h2>Record Built Environment Features</h2>
                <label for="feature">Feature Type:</label>
                <select id="feature" name="feature">
                    <option value="building">Building</option>
                    <option value="road">Road</option>
                    <option value="park">Park</option>
                    <option value="other">Other</option>
                </select>
                <label for="condition">Condition:</label>
                <select id="condition" name="condition">
                    <option value="excellent">Excellent</option>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="poor">Poor</option>
                </select>
                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes" rows="4"></textarea>
            </form>
            <div id="buttons">
                <button id="recordData">Record Data</button>
                <button id="downloadDataset">Download Dataset</button>
            </div>
            <div id="observationCount"></div>
        </div>
        <div id="map"></div>
        <div id="pano"></div>
    </div>

    <script>
        let map, panorama, drawingManager;
        let selectedArea;
        let streetViewService;
        let observations = [];

        function initMap() {
            const defaultLocation = { lat: 49.886324, lng: -119.493484 }; // Kelowna

            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 14,
            });

            panorama = new google.maps.StreetViewPanorama(
                document.getElementById("pano"),
                {
                    position: defaultLocation,
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1,
                    visible: true
                }
            );

            map.setStreetView(panorama);

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['rectangle'],
                },
            });

            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedArea) {
                    selectedArea.setMap(null);
                }
                selectedArea = event.overlay;
                drawingManager.setDrawingMode(null);
            });

            streetViewService = new google.maps.StreetViewService();

            google.maps.event.addListener(panorama, 'position_changed', function() {
                updateImageDateSelector();
            });

            updateImageDateSelector();
            loadObservations();
            updateObservationCount();

            document.getElementById('recordData').addEventListener('click', recordObservation);
            document.getElementById('downloadDataset').addEventListener('click', downloadDataset);
        }

        function updateImageDateSelector() {
    const dateSelect = document.getElementById('imageDate');
    dateSelect.innerHTML = '';

    const request = {
        location: panorama.getPosition(),
        radius: 50,
        source: google.maps.StreetViewSource.OUTDOOR
    };

    streetViewService.getPanorama(request, function(data, status) {
        if (status === google.maps.StreetViewStatus.OK) {
            if (data.time && data.time.length > 0) {
                data.time.forEach((timestamp, index) => {
                    const option = document.createElement('option');
                    option.value = data.location.pano;
                    
                    // Convert timestamp to date string
                    let date;
                    if (typeof timestamp === 'number') {
                        // If timestamp is a number (unix timestamp), multiply by 1000 for milliseconds
                        date = new Date(timestamp * 1000);
                    } else {
                        // If timestamp is already a Date object or a date string
                        date = new Date(timestamp);
                    }
                    
                    if (isNaN(date.getTime())) {
                        // If date is invalid, use a placeholder
                        option.textContent = 'Unknown Date';
                    } else {
                        option.textContent = date.toLocaleDateString();
                    }
                    
                    dateSelect.appendChild(option);

                    if (index === 0) {
                        panorama.setPano(data.location.pano);
                    }
                });

                dateSelect.removeEventListener('change', dateSelectChangeHandler);
                dateSelect.addEventListener('change', dateSelectChangeHandler);
            } else {
                const option = document.createElement('option');
                option.textContent = 'No historical imagery available';
                dateSelect.appendChild(option);
            }
        } else {
            console.error('Street View data not found for this location.');
        }
    });
}

        function dateSelectChangeHandler() {
            const selectedPano = this.value;
            panorama.setPano(selectedPano);
        }

        function recordObservation() {
            const formData = new FormData(document.getElementById('form'));
            const observation = {
                feature: formData.get('feature'),
                condition: formData.get('condition'),
                notes: formData.get('notes'),
                lat: panorama.getPosition().lat(),
                lng: panorama.getPosition().lng(),
                heading: panorama.getPov().heading,
                pitch: panorama.getPov().pitch,
                imageDate: document.getElementById('imageDate').options[document.getElementById('imageDate').selectedIndex].textContent
            };

            observations.push(observation);
            saveObservations();
            updateObservationCount();

            // Clear form
            document.getElementById('form').reset();
        }

        function downloadDataset() {
            const csv = Papa.unparse(observations);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "virtual_audit_dataset.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function saveObservations() {
            localStorage.setItem('virtualAuditObservations', JSON.stringify(observations));
        }

        function loadObservations() {
            const savedObservations = localStorage.getItem('virtualAuditObservations');
            if (savedObservations) {
                observations = JSON.parse(savedObservations);
            }
        }

        function updateObservationCount() {
            document.getElementById('observationCount').textContent = `Total Observations: ${observations.length}`;
        }

        (function() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBNVN2mixyttHxNeZjX63A96vEMtx0Nmio&libraries=drawing&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>
