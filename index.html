<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Street Audit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: grid;
            grid-template-columns: 30% 70%;
            grid-template-rows: 60% 40%;
            height: 100vh;
        }
        #controlArea {
            grid-column: 1;
            grid-row: 1;
            padding: 20px;
            overflow-y: auto;
        }
        #map {
            grid-column: 1;
            grid-row: 2;
        }
        #pano {
            grid-column: 2;
            grid-row: 1 / span 2;
        }
        #form, #dateSelector, #buttons {
            margin-bottom: 20px;
        }
        #observationCount {
            margin-top: 10px;
            font-weight: bold;
        }
        h1, h2 {
            margin-top: 0;
        }
        select, textarea {
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            margin-right: 10px;
        }
        .date-fields {
            margin-bottom: 15px;
        }
        .date-field {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="controlArea">
            <h1>Virtual Street Audit</h1>
            <div id="dateSelector">
                <label for="imageDate">Select Image Date:</label>
                <select id="imageDate"></select>
            </div>
            <div class="date-fields">
                <div class="date-field">
                    <label for="currentImageryDate">Current Imagery Date:</label>
                    <input type="text" id="currentImageryDate" name="currentImageryDate" readonly>
                </div>
                <div class="date-field">
                    <label for="backupImageryDate">Backup Date:</label>
                    <input type="text" id="backupImageryDate" name="backupImageryDate" readonly>
                </div>
            </div>
            <form id="form">
                <h2>Record instances of urban change</h2>
                
                <label for="groupNumber">Group/map area number:</label>
                <input type="text" id="groupNumber" name="groupNumber">
                
                <label for="feature">Feature/object type:</label>
                <select id="feature" name="feature">
                    <option value="apartment">Apartment/condo building</option>
                    <option value="office">Office building</option>
                    <option value="house">House</option>
                    <option value="restaurant">Restaurant/bar</option>
                    <option value="store">Store</option>
                    <option value="construction">Construction site</option>
                    <option value="street">Street Infrastructure</option>
                    <option value="public">Public space</option>
                    <option value="green">Green space</option>
                    <option value="trees">Trees</option>
                    <option value="art">Art/mural</option>
                    <option value="other">Other</option>
                </select>

                <label for="change">Feature/object change:</label>
                <select id="change" name="change">
                    <option value="new">Changed to new feature</option>
                    <option value="same-type">Changed but same feature type</option>
                    <option value="upgraded">Same feature but upgraded/renovated</option>
                    <option value="na">Not applicable</option>
                </select>

                <label for="notes">Explanation of change:</label>
                <textarea id="notes" name="notes" rows="4"></textarea>
            </form>
            <div id="buttons">
                <button id="recordData">Record Data</button>
                <button id="downloadDataset">Download Dataset</button>
                <button id="clearData">Clear All Data</button>
            </div>
            <div id="observationCount"></div>
        </div>
        <div id="map"></div>
        <div id="pano"></div>
    </div>

    <script>
        let map, panorama, drawingManager;
        let selectedArea;
        let streetViewService;
        let geocoder;
        let observations = [];
        let isChangingDate = false;
        let currentPanoData = null;
        let selectedDate = null;
        let isUpdatingPanorama = false;

        function initMap() {
            const defaultLocation = { lat: 49.886324, lng: -119.493484 }; // Kelowna

            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 14,
            });

            panorama = new google.maps.StreetViewPanorama(
                document.getElementById("pano"),
                {
                    position: defaultLocation,
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1,
                    visible: true
                }
            );

            map.setStreetView(panorama);

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['rectangle'],
                },
            });

            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedArea) {
                    selectedArea.setMap(null);
                }
                selectedArea = event.overlay;
                drawingManager.setDrawingMode(null);
            });

            streetViewService = new google.maps.StreetViewService();
            geocoder = new google.maps.Geocoder();

            google.maps.event.addListener(panorama, 'position_changed', function() {
                if (!isChangingDate && !isUpdatingPanorama) {
                    isUpdatingPanorama = true;
                    setTimeout(() => {
                        updateImageDateSelector();
                        isUpdatingPanorama = false;
                    }, 500);
                }
            });

            updateImageDateSelector();
            loadObservations();
            updateObservationCount();

            document.getElementById('recordData').addEventListener('click', recordObservation);
            document.getElementById('downloadDataset').addEventListener('click', downloadDataset);
            document.getElementById('clearData').addEventListener('click', clearAllData);
        }

        function updateImageDateSelector() {
            const dateSelect = document.getElementById('imageDate');
            const currentImageryDateInput = document.getElementById('currentImageryDate');
            const backupImageryDateInput = document.getElementById('backupImageryDate');
            dateSelect.innerHTML = '';

            const request = {
                location: panorama.getPosition(),
                radius: 50,
                source: google.maps.StreetViewSource.OUTDOOR
            };

            streetViewService.getPanorama(request, function(data, status) {
                console.log("StreetViewService response:", data);
                
                // Update backup date field
                if (data.imageDate) {
                    backupImageryDateInput.value = data.imageDate;
                } else {
                    backupImageryDateInput.value = 'No backup date available';
                }

                if (status === google.maps.StreetViewStatus.OK) {
                    currentPanoData = data;
                    if (data.time && data.time.length > 0) {
                        console.log("Time data:", data.time);
                        
                        // Create a map of panos to dates for backup date lookup
                        const panoDateMap = new Map();
                        
                        data.time.forEach((timeObj, index) => {
                            console.log(`Processing time object ${index}:`, timeObj);
                            const option = document.createElement('option');
                            option.value = timeObj.pano;
                            
                            // Try all possible property names for the date
                            const dateProp = timeObj.Iu || timeObj.su || timeObj.ou || timeObj.tu || 
                                           Object.values(timeObj).find(prop => prop instanceof Date);
                            
                            let dateString = 'Unknown Date';
                            if (dateProp) {
                                console.log(`Date property found:`, dateProp);
                                dateString = dateProp.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
                            } else if (data.imageDate) {
                                // Use imageDate as backup for the current panorama
                                if (timeObj.pano === data.location.pano) {
                                    console.log(`Using imageDate from response:`, data.imageDate);
                                    // Convert YYYY-MM format to readable date
                                    const [year, month] = data.imageDate.split('-');
                                    const date = new Date(year, month - 1);
                                    dateString = date.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
                                }
                            }
                            
                            panoDateMap.set(timeObj.pano, dateString);
                            console.log(`Resulting date string:`, dateString);
                            option.textContent = dateString;
                            dateSelect.appendChild(option);

                            // If this is the current panorama, update the currentImageryDate input
                            if (timeObj.pano === panorama.getPano()) {
                                currentImageryDateInput.value = dateString;
                            }
                        });

                        // Store the panoDateMap for later use
                        window.panoDateMap = panoDateMap;

                        // Select the previously selected date if available, otherwise select the most recent
                        const dateToSelect = selectedDate || dateSelect.options[0].textContent;
                        for (let i = 0; i < dateSelect.options.length; i++) {
                            if (dateSelect.options[i].textContent === dateToSelect) {
                                dateSelect.selectedIndex = i;
                                break;
                            }
                        }

                        if (!isChangingDate) {
                            panorama.setPano(dateSelect.value);
                        }

                        dateSelect.removeEventListener('change', dateSelectChangeHandler);
                        dateSelect.addEventListener('change', dateSelectChangeHandler);
                    } else {
                        console.log("No time data available");
                        const option = document.createElement('option');
                        option.textContent = 'No historical imagery available';
                        dateSelect.appendChild(option);
                        currentImageryDateInput.value = 'No date available';
                    }
                } else {
                    console.error('Street View data not found for this location.');
                    currentImageryDateInput.value = 'No date available';
                }
            });
        }

        function dateSelectChangeHandler() {
            selectedDate = this.options[this.selectedIndex].textContent;
            const selectedPano = this.value;
            if (selectedPano !== panorama.getPano()) {
                isChangingDate = true;
                panorama.setPano(selectedPano);
                document.getElementById('currentImageryDate').value = window.panoDateMap.get(selectedPano) || selectedDate;
                setTimeout(() => {
                    isChangingDate = false;
                }, 100);
            }
        }

        function getStreetAddress(lat, lng, callback) {
            const latlng = { lat: lat, lng: lng };
            geocoder.geocode({ location: latlng }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        callback(results[0].formatted_address);
                    } else {
                        callback("No address found");
                    }
                } else {
                    callback("Geocoder failed due to: " + status);
                }
            });
        }

        function recordObservation() {
            const formData = new FormData(document.getElementById('form'));
            const lat = panorama.getPosition().lat();
            const lng = panorama.getPosition().lng();

            getStreetAddress(lat, lng, function(address) {
                const now = new Date();
                const localTimestamp = now.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: false
                });

                const observation = {
                    timestamp: localTimestamp,
                    groupNumber: formData.get('groupNumber'),
                    feature: formData.get('feature'),
                    change: formData.get('change'),
                    notes: formData.get('notes'),
                    lat: lat,
                    lng: lng,
                    heading: panorama.getPov().heading,
                    pitch: panorama.getPov().pitch,
                    imageDate: document.getElementById('currentImageryDate').value,
                    backupDate: document.getElementById('backupImageryDate').value,
                    streetAddress: address
                };

                observations.push(observation);
                saveObservations();
                updateObservationCount();

                // Clear form except for the groupNumber
                const groupNumber = document.getElementById('groupNumber').value;
                document.getElementById('form').reset();
                document.getElementById('groupNumber').value = groupNumber;
                
                // Re-populate the date fields
                document.getElementById('currentImageryDate').value = window.panoDateMap.get(panorama.getPano()) || selectedDate;
            });
        }

        function downloadDataset() {
            const csv = Papa.unparse(observations);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "virtual_audit_dataset.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function clearAllData() {
            if (confirm("Are you sure you want to delete all recorded observations? This action cannot be undone.")) {
                localStorage.removeItem('virtualAuditObservations');
                observations = [];
                updateObservationCount();
                alert("All data has been cleared.");
            }
        }

        function saveObservations() {
            localStorage.setItem('virtualAuditObservations', JSON.stringify(observations));
        }

        function loadObservations() {
            const savedObservations = localStorage.getItem('virtualAuditObservations');
            if (savedObservations) {
                observations = JSON.parse(savedObservations);
            }
            updateObservationCount();
        }

        function updateObservationCount() {
            document.getElementById('observationCount').textContent = `Total Observations: ${observations.length}`;
        }
